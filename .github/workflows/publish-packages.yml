name: Publish Packages

on:
  push:
    branches: [main]
    paths:
      - 'packages/**'
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
      - 'bahmni-services-v[0-9]+.[0-9]+.[0-9]+'
      - 'bahmni-widgets-v[0-9]+.[0-9]+.[0-9]+'
      - 'bahmni-design-system-v[0-9]+.[0-9]+.[0-9]+'
  workflow_dispatch:

env:
  NODE_VERSION: '22'

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      packages: ${{ steps.set-packages.outputs.packages }}
      has-changes: ${{ steps.set-packages.outputs.has-changes }}
      is-tag: ${{ steps.set-packages.outputs.is-tag }}
      tag-version: ${{ steps.set-packages.outputs.tag-version }}
      target-package: ${{ steps.set-packages.outputs.target-package }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - run: yarn install --frozen-lockfile

      - id: set-packages
        run: |
          IS_TAG="false"
          TAG_VERSION=""
          TARGET_PACKAGE=""

          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            IS_TAG="true"
            TAG="${{ github.ref_name }}"

            if [[ "$TAG" =~ ^v([0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
              TAG_VERSION="${BASH_REMATCH[1]}"
              echo "Global tag detected: v${TAG_VERSION}"
            elif [[ "$TAG" =~ ^(bahmni-services|bahmni-widgets|bahmni-design-system)-v([0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
              TARGET_PACKAGE="${BASH_REMATCH[1]}"
              TAG_VERSION="${BASH_REMATCH[2]}"
              echo "Package-specific tag detected: ${TARGET_PACKAGE}-v${TAG_VERSION}"
            else
              echo "Error: Invalid tag format. Expected v{semver} or {package}-v{semver}"
              exit 1
            fi
          fi

          echo "is-tag=$IS_TAG" >> $GITHUB_OUTPUT
          echo "tag-version=$TAG_VERSION" >> $GITHUB_OUTPUT
          echo "target-package=$TARGET_PACKAGE" >> $GITHUB_OUTPUT

          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            AFFECTED_PACKAGES='["bahmni-services","bahmni-widgets","bahmni-design-system"]'
          else
            AFFECTED=$(npx nx show projects --affected --base=HEAD~1 --head=HEAD --type=lib)
            PACKAGES=()

            for package in @bahmni-frontend/bahmni-services @bahmni-frontend/bahmni-widgets @bahmni-frontend/bahmni-design-system; do
              if echo "$AFFECTED" | grep -q "^${package}$"; then
                if [ "$IS_TAG" == "true" ] && [ -n "$TARGET_PACKAGE" ] && [ "$TARGET_PACKAGE" != "$package" ]; then
                  continue
                fi
                PACKAGES+=("\"$package\"")
              fi
            done

            AFFECTED_PACKAGES="[$(IFS=,; echo "${PACKAGES[*]}")]"
            [ ${#PACKAGES[@]} -eq 0 ] && AFFECTED_PACKAGES='[]'
          fi

          echo "packages=$AFFECTED_PACKAGES" >> $GITHUB_OUTPUT
          [ "$AFFECTED_PACKAGES" == "[]" ] && echo "has-changes=false" >> $GITHUB_OUTPUT || echo "has-changes=true" >> $GITHUB_OUTPUT
          echo "Packages to publish: $AFFECTED_PACKAGES"

  test-and-build:
    needs: detect-changes
    if: needs.detect-changes.outputs.has-changes == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        package: ${{ fromJson(needs.detect-changes.outputs.packages) }}
      fail-fast: false
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - run: yarn install --frozen-lockfile
      - run: npx nx lint ${{ matrix.package }}
      - run: npx nx test ${{ matrix.package }}
      - run: npx nx build ${{ matrix.package }}

  publish:
    needs: [detect-changes, test-and-build]
    if: needs.detect-changes.outputs.has-changes == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    strategy:
      matrix:
        package: ${{ fromJson(needs.detect-changes.outputs.packages) }}
      fail-fast: false
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'
          registry-url: 'https://registry.npmjs.org'

      - run: yarn install --frozen-lockfile
      - run: npx nx build ${{ matrix.package }}

      - id: version
        working-directory: packages/${{ matrix.package }}
        run: |
          BASE_VERSION=$(node -p "require('./package.json').version")

          if [ "${{ needs.detect-changes.outputs.is-tag }}" == "true" ]; then
            PUBLISH_VERSION="${{ needs.detect-changes.outputs.tag-version }}"
            DIST_TAG="latest"
          else
            PUBLISH_VERSION="${BASE_VERSION}-dev.${{ github.run_number }}"
            DIST_TAG="dev"
          fi

          echo "version=$PUBLISH_VERSION" >> $GITHUB_OUTPUT
          echo "dist-tag=$DIST_TAG" >> $GITHUB_OUTPUT
          echo "Publishing @bahmni-frontend/${{ matrix.package }}@${PUBLISH_VERSION} with tag ${DIST_TAG}"

      - working-directory: packages/${{ matrix.package }}
        run: |
          npm version ${{ steps.version.outputs.version }} --no-git-tag-version
          npm publish --access public --tag ${{ steps.version.outputs.dist-tag }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - if: needs.detect-changes.outputs.is-tag == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if [ -z "${{ needs.detect-changes.outputs.target-package }}" ]; then
            TAG_NAME="${{ matrix.package }}-v${{ steps.version.outputs.version }}"
            git tag -a "$TAG_NAME" -m "Release ${{ matrix.package }} v${{ steps.version.outputs.version }}"
            git push origin "$TAG_NAME"
          fi
